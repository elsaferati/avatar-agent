<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Presenter</title>
    <style>
        body { background: #0b0f1a; color: #e9eefb; font-family: sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        .col { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .left { flex: 3; border-right: 1px solid #333; }
        .right { flex: 1.2; background: #131826; }
       
        /* Slide Stage */
        #pdf-stage { flex: 1; background: #000; border-radius: 8px; display: flex; justify-content: center; align-items: center; border: 1px solid #333; }
        canvas { max-width: 100%; max-height: 100%; }
       
        /* Avatar Stage */
        #avatar-stage { height: 400px; background: #000; border-radius: 8px; border: 1px solid #333; overflow: hidden; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
       
        /* Controls */
        .btn { background: #4da3ff; color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #7abeff; }
        .btn:disabled { background: #333; color: #888; cursor: not-allowed; }
        textarea { width: 90%; background: #0f1421; color: white; border: 1px solid #333; padding: 10px; border-radius: 6px; resize: none; margin-bottom: 10px;}
       
        .interacting { border: 2px solid #4da3ff !important; box-shadow: 0 0 20px rgba(77,163,255,0.3); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
</head>
<body>
    <div class="col left">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ðŸ“Š Slide Deck</h2>
            <div>
                <input type="file" id="pdf-input" accept="application/pdf" style="color:#888">
                <button id="present-btn" class="btn" disabled>â–¶ Start Presentation</button>
            </div>
        </div>
        <div id="pdf-stage"><canvas id="pdf-canvas"></canvas></div>
        <div id="caption" style="color:#888; min-height: 20px; font-style: italic;">Waiting for slides...</div>
    </div>
 
    <div class="col right">
        <h2>ðŸ¤– AI Presenter</h2>
       
        <div id="avatar-stage">
            <div id="connect-overlay" style="position:absolute; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.8); z-index: 10;">
                <button id="connect-btn" class="btn">Connect Avatar</button>
            </div>
            <iframe id="simli-frame" allow="camera; microphone; autoplay"></iframe>
        </div>
 
        <div style="margin-top:auto;">
            <p>Interrupt the presenter:</p>
            <textarea id="question-input" rows="3" placeholder="Type a question..."></textarea>
            <button id="ask-btn" class="btn" style="width:100%;">Ask Question</button>
        </div>
    </div>
 
    <script>
        let pdfDoc = null, pageNum = 1, isConnected = false;
        let isInteracting = false;
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const BASE_URL = 'http://127.0.0.1:3000'; 
 
        // 1. PDF LOADER
        document.getElementById('pdf-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const data = new Uint8Array(await file.arrayBuffer());
            pdfDoc = await pdfjsLib.getDocument({ data }).promise;
            renderPage(1);
            document.getElementById('present-btn').disabled = false;
            document.getElementById('caption').textContent = `Loaded ${pdfDoc.numPages} slides.`;
        });
 
        function renderPage(num) {
            pageNum = num;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale: 1.2 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                page.render({ canvasContext: ctx, viewport: viewport });
            });
        }
 
        async function getPageText(num) {
            const page = await pdfDoc.getPage(num);
            const content = await page.getTextContent();
            return content.items.map(i => i.str).join(' ');
        }

        // Helper to update the iframe safely
        function updateAvatar(roomUrl) {
            const frame = document.getElementById('simli-frame');
            // Add autojoin parameters to skip the "Join Room" button in Simli
            frame.src = `${roomUrl}?autojoin=1`;
        }
 
        // 2. CONNECT AVATAR (Initial Connection)
        document.getElementById('connect-btn').onclick = async () => {
            const btn = document.getElementById('connect-btn');
            btn.textContent = "Connecting...";
            try {
                const res = await fetch(`${BASE_URL}/simli/start-session`, { method: 'POST' });
                const data = await res.json();
                
                // Simli usually returns roomUrl or meetingUrl
                const url = data.roomUrl || data.meetingUrl;

                if(url) {
                    updateAvatar(url);
                    document.getElementById('connect-overlay').style.display = 'none';
                    isConnected = true;
                    document.getElementById('caption').textContent = "Avatar connected. Ready to present.";
                } else {
                    alert("Error: No URL received. Check server console.");
                }
            } catch(e) {
                alert("Connection failed: " + e.message);
                btn.textContent = "Retry";
            }
        };
 
        // 3. PRESENTATION LOOP
        document.getElementById('present-btn').onclick = async () => {
            if(!isConnected) return alert("Please click 'Connect Avatar' first.");
           
            const btn = document.getElementById('present-btn');
            btn.disabled = true;
            btn.textContent = "Presenting...";
 
            for(let i = 1; i <= pdfDoc.numPages; i++) {
                if(isInteracting) { i--; await smartDelay(1000); continue; } // Pause loop if answering

                renderPage(i);
               
                document.getElementById('caption').textContent = `Analyzing Slide ${i}...`;
                const text = await getPageText(i);
                
                try {
                    const res = await fetch(`${BASE_URL}/agent/present`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ slide_text: text })
                    });
                    const data = await res.json();
                
                    document.getElementById('caption').textContent = "Speaking...";
                    
                    // The server uses 'auto/start/configurable' which returns a NEW room/video URL for this specific speech
                    if(data.simli && (data.simli.roomUrl || data.simli.meetingUrl)) {
                        updateAvatar(data.simli.roomUrl || data.simli.meetingUrl);
                    }

                    // Estimate speech duration to stay on slide
                    const words = data.speech.split(' ').length;
                    const durationMs = (words / 2.5) * 1000 + 4000; // Buffer for startup
                    await smartDelay(durationMs);

                } catch(e) {
                    console.error(e);
                    document.getElementById('caption').textContent = "Error generating speech.";
                }
            }
           
            btn.textContent = "Presentation Finished";
            btn.disabled = false;
        };
 
        // 4. ASK QUESTION
        document.getElementById('ask-btn').onclick = async () => {
            const q = document.getElementById('question-input').value;
            if(!q) return;
 
            isInteracting = true; // PAUSE SLIDES
            document.getElementById('avatar-stage').classList.add('interacting');
            document.getElementById('caption').textContent = "Thinking...";
 
            const currentSlideText = await getPageText(pageNum);
            
            try {
                const res = await fetch(`${BASE_URL}/agent/interact`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_question: q, slide_context: currentSlideText })
                });
                const data = await res.json();
            
                document.getElementById('question-input').value = "";
                document.getElementById('caption').textContent = "Answering...";

                // Update iframe with the Answer video
                if(data.simli && (data.simli.roomUrl || data.simli.meetingUrl)) {
                    updateAvatar(data.simli.roomUrl || data.simli.meetingUrl);
                }
            
                // Wait for answer
                const words = data.answer.split(' ').length;
                const durationMs = (words / 2.5) * 1000 + 3000;
    
                setTimeout(() => {
                    isInteracting = false; // RESUME SLIDES
                    document.getElementById('avatar-stage').classList.remove('interacting');
                    document.getElementById('caption').textContent = "Resuming presentation...";
                }, durationMs);

            } catch (e) {
                alert("Interaction failed");
                isInteracting = false;
            }
        };
 
        function smartDelay(ms) {
            return new Promise(resolve => {
                const step = 200;
                let elapsed = 0;
                const timer = setInterval(() => {
                    // Only count time if NOT interacting
                    if(!isInteracting) elapsed += step;
                    if(elapsed >= ms) {
                        clearInterval(timer);
                        resolve();
                    }
                }, step);
            });
        }
    </script>
</body>
</html>